from fastapi.testclient import TestClient
from api.unified_api import app
import os
import pytest

# Set environment variable for API keys
os.environ["QU_LAB_MASTER_KEYS"] = "secure_key_jules_2025"

def test_websocket_no_auth():
    client = TestClient(app)
    try:
        with client.websocket_connect("/ws/materials") as websocket:
            print("Successfully connected to WebSocket without authentication!")
            websocket.send_text('{"test": "data"}')
            data = websocket.receive_json()
            print(f"Received: {data}")
            return True
    except Exception as e:
        print(f"Failed to connect: {e}")
        return False

if __name__ == "__main__":
    vulnerable = test_websocket_no_auth()
    if vulnerable:
        print("VULNERABILITY CONFIRMED: WebSocket connected without authentication.")
    else:
        print("Vulnerability not reproduced or already fixed.")
