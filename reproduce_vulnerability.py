import asyncio
import websockets
import json
import os
import subprocess
import time
import signal

async def test_websocket_no_auth():
    uri = "ws://localhost:8000/ws/materials"
    try:
        async with websockets.connect(uri) as websocket:
            print("Successfully connected to WebSocket without authentication!")
            await websocket.send(json.dumps({"test": "data"}))
            response = await websocket.recv()
            print(f"Received: {response}")
            return True
    except Exception as e:
        print(f"Failed to connect (as expected if fixed): {e}")
        return False

def run_server():
    env = os.environ.copy()
    env["QU_LAB_MASTER_KEYS"] = "secure_key_jules_2025"
    process = subprocess.Popen(
        ["python3", "api/unified_api.py"],
        env=env,
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
        preexec_fn=os.setsid
    )
    return process

async def main():
    server_process = run_server()
    print("Starting server...")
    # Wait for server to start
    await asyncio.sleep(5)

    success = await test_websocket_no_auth()

    # Kill the server
    os.killpg(os.getpgid(server_process.pid), signal.SIGTERM)

    if success:
        print("VULNERABILITY CONFIRMED: WebSocket connected without authentication.")
    else:
        print("Vulnerability not reproduced or already fixed.")

if __name__ == "__main__":
    asyncio.run(main())
